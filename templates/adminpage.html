
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>排队取号系统</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #f0f8ff, #cde0ff);
      text-align: center;
      padding-top: 80px;
    }
    h2 {
      color: #2a35ff;
      margin-bottom: 30px;
    }
  .admin-container {
    text-align: center;
    padding: 20px;
  }

  .called-list {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin: 20px 0;
  }

  .called-item {
    border: 2px solid #333;
    border-radius: 10px;
    padding: 10px 15px;
    min-width: 120px;
  }

  .action-btns {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
  }

  button {
    padding: 10px 13px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 5px;
  }
  input {
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 250px;
    outline: none;
    margin-top: 15px;
  }

  .calling .change{
    margin-top: 40px;
    font-size: 20px;
    font-weight: bold;
    color: #333;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    width: 85%;
    max-width: 400px;
    line-height: 1.6;
  }

  .signageBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4e73df;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(78,115,223,0.3);
    transition: 0.3s;
  }
  </style>
</head>


<body>
  <button id="signageBtn" onclick="go_signagepage()">サイネージ展示ページ</button>
  <div class="admin-container">
    <h2>現在呼び出し中の番号 / Currently Calling</h2>
    <p id="calling"></p><br>
    <div id="called-list" class="called-list">
      <button id="start_button" onclick="user_start()" class="next-btn">start・next</button>
      <button id="end_button" onclick="user_end()" class="next-btn">end</button>
      <button id="check_button" onclick="user_check()" class="next-btn">check</button>
      <button id="pass_button" onclick="user_pass()" class="next-btn">pass</button>
    </div>
    <br>
    <p style="font-size:25px; color:#000000; margin-top:15px;">
    状態管理
    </p>
    <br>
    <input type="text" id="target_id" placeholder="input target id">
    <br> 
    <button id="waiting_change" onclick="change('waiting')" class="next-btn">waiting</button>
    <button id="pass_change" onclick="change('passed')" class="next-btn">passed</button>
    <button id="expired" onclick="change('expired')" class="next-btn">expired</button>
    <p id=change style="font: size 20px; color:#000000; margin-top:15px;"></p><br>
  </div>
  


  <script>
    var current_id = -1
    var user_count = 0

    async function user_start() {
      const res = await fetch("/get_next_user", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({current_id: current_id})
      });

      let next_user = await res.json();
      if (next_user.status == 0) {
        const user_id = next_user.data[0].id;
        const user_name = next_user.data[0].name;
        document.getElementById("calling").innerHTML = `
        ${user_id}番：${user_name}様<br>
        現在のグループ人数：${user_count}人
        `
        current_id = user_id
      }
      else if (next_user.status == 1){
        document.getElementById("calling").innerHTML = `
        もう最後です<br>
        現在のグループ人数：${user_count}人`
      }
    }

    async function user_end() {
      current_id = -1
      user_count = 0
      document.getElementById("calling").innerHTML = `
        プレー中<br>
        start押して番号呼び始めます`
    }

    async function user_check() {
      const res = await fetch("/check_current_user", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({current_id: current_id})
      });

      let current_user = await res.json();
      if (current_user.status == 0) {
        const user_id = current_user.data[0].id;
        const user_name = current_user.data[0].name;
        const user_status = current_user.data[0].status;
        user_count = user_count + 1
        document.getElementById("calling").innerHTML = `
        ${user_id}番：${user_name}様をチェックしました<br>
        現在のグループ人数：${user_count}人
        `
      }
      else if (current_user.status == 1){
      document.getElementById("calling").innerHTML = `
        error happend
        `}
      else if (current_user.status == 2){
      const user_id = current_user.data[0].id;
      const user_name = current_user.data[0].name;
      document.getElementById("calling").innerHTML = `
        ${user_id}番：${user_name}様はすでにチェックされました<br>
        現在のグループ人数：${user_count}人
        `}
      else if (current_user.status == 3){
      const user_id = current_user.data[0].id;
      const user_name = current_user.data[0].name;
      document.getElementById("calling").innerHTML = `
        ${user_id}番：${user_name}様はすでにExpiredされました<br>
        現在のグループ人数：${user_count}人
        `}
    }

    async function user_pass() {
      const res = await fetch("/pass_current_user", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({current_id: current_id})
      });

      let current_user = await res.json();
      if (current_user.status == "passed") {
        const user_id = current_user.data[0].id;
        const user_name = current_user.data[0].name;
        document.getElementById("calling").innerHTML = `
        ${user_id}番：${user_name}様をPassしました<br>
        現在のグループ人数：${user_count}人
        `
      }
      else if (current_user.status == "expired") {
        const user_id = current_user.data[0].id;
        const user_name = current_user.data[0].name;
        document.getElementById("calling").innerHTML = `
        ${user_id}番：${user_name}様をPassしました(Expiredされました)<br>
        現在のグループ人数：${user_count}人
        `
      }
      else {document.getElementById("calling").innerHTML = "error"}
    }

    async function change(new_status) {
      let target_id = document.getElementById("target_id").value;
      const res = await fetch("/status_change", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({target_id: target_id, new_status: new_status})
      });

      let current_user = await res.json()
      if (current_user.status == 0){
        const user_id = current_user.data[0].id;
        const user_name = current_user.data[0].name;
        const user_status = current_user.data[0].status;
        document.getElementById("change").innerHTML = `
        修正成功<br>
        id: ${user_id}, name: ${user_name}, status: ${user_status}
        `
      }
      else if (current_user.status == 1){
        document.getElementById("change").innerHTML = `
          該当ユーザー見つかりません
        `
      }
    }

    async function go_signagepage() {
      window.location.href = "/go_signagepage"; 
    }
  </script>
</body>
</html>
